# PearSync v2 CLI Integration - Handoff

**Date:** 2026-02-07  
**Session:** Marshall debugging Autobase multi-writer integration  
**Status:** Cross-peer sync working, remaining work on bidirectional + CLI verification

---

## What Was Done This Session

### 1. Fixed Autobase Multi-Writer Pattern
**Problem:** `addWriter()` wasn't adding writers to `activeWriters`  
**Root Cause:** Using `{ indexer: false }` - must use default `{ indexer: true }`  
**Fix:** Updated `lib/autobase.js` line ~55 to call `base.addWriter(key)` without options

### 2. Fixed Swarm Topic Selection
**Problem:** Peers weren't finding each other reliably  
**Root Cause:** Using local writer key as swarm topic instead of autobase discovery key  
**Fix:** Updated `lib/sync-v2.js` to use `this.autobase.base.discoveryKey` as topic

### 3. Fixed File Content Replication
**Problem:** Hyperblobs content not replicating (each peer had separate blobs core)  
**Root Cause:** Named cores (`{ name: 'blobs' }`) create unique keys per corestore  
**Fix:** Embed file content directly in autobase entries (base64 encoded)

### 4. Added Integration Tests
- `test/integration/sync-v2-direct.test.js` - Cross-peer file sync tests
- All 3 integration tests passing

---

## Current Test Status

```bash
# Run all sync-v2 tests
cd /home/exedev/projects/pearsync
npx brittle test/unit/sync-v2.test.js          # 7/7 passing
npx brittle test/unit/writer-mgmt.test.js       # 5/5 passing
npx brittle test/integration/sync-v2-direct.test.js  # 3/3 passing
```

---

## Key Files

| File | Purpose |
|------|---------|
| `lib/sync-v2.js` | New SyncEngine using Autobase + embedded content |
| `lib/autobase.js` | PearSyncAutobase wrapper for Autobase |
| `lib/sync.js` | OLD v1 SyncEngine (Hyperdrive-based, kept for reference) |
| `bin/pearsync.js` | CLI - updated to use sync-v2 |
| `test/unit/sync-v2.test.js` | Unit tests for sync-v2 |
| `test/unit/writer-mgmt.test.js` | Writer addition/removal tests |
| `test/integration/sync-v2-direct.test.js` | Cross-peer sync tests |

---

## Architecture: v2 vs v1

### v1 (Hyperdrive - OLD)
```
Hyperdrive (single writer) → Hyperswarm → Localdrive
- Creator is writer, joiners are readers
- Uses Hyperdrive's built-in blob storage
```

### v2 (Autobase - NEW)
```
Autobase (multi-writer) → Hyperswarm → Localdrive
- All peers are writers
- Content embedded in autobase entries (base64)
- Writer keys exchanged over socket protocol
```

---

## Writer Key Exchange Protocol

When peers connect via Hyperswarm:
1. Each peer sends: `{"type":"writer-key","key":"<hex>"}\n`
2. Receiving peer appends: `{ type: 'add-writer', writerKey: key }` or `{ add: key }`
3. Autobase's `apply` function processes this and calls `base.addWriter()`
4. After replication, both peers can write

See `_exchangeWriterKeys()` in `lib/sync-v2.js` (around line 180)

---

## Remaining Work

### 1. Bidirectional Sync Test
Both peers writing files simultaneously and verifying sync in both directions.

**Test approach:**
```javascript
// Peer A creates file1.txt
// Peer B creates file2.txt
// Both sync
// Verify: A has file2.txt, B has file1.txt
```

### 2. CLI Manual Verification
Test actual CLI commands between two machines:

**On hals-shell:**
```bash
cd /home/exedev/projects/pearsync
node bin/pearsync.js init ~/sync-test-v2 --name test-v2
# Note the key
node bin/pearsync.js watch test-v2 --foreground --verbose
```

**On sprite (or another machine):**
```bash
node bin/pearsync.js join <KEY> ~/sync-test-v2 --name test-v2
node bin/pearsync.js watch test-v2 --foreground --verbose
```

### 3. Large File Handling
Current approach embeds content as base64 in JSON. This has limitations:
- Memory usage for large files
- Base64 overhead (~33% size increase)

**Future improvement:** Implement shared Hyperblobs core or chunked transfer

### 4. Delete Propagation
Verify that file deletions sync correctly:
```bash
# On peer A, delete a file
rm ~/sync-test-v2/somefile.txt
# Verify it's removed on peer B
```

### 5. Config Migration
Old workspaces have `isWriter: true/false`. New v2 ignores this but config still stores it.
Consider adding migration or cleanup.

---

## Known Limitations

1. **File size:** Large files may cause memory issues (embedded base64)
2. **Binary files:** Work but with 33% overhead
3. **Concurrent writes:** Same file edited by both peers - last write wins (Autobase LWW)
4. **Network latency:** DHT discovery takes 5-15 seconds

---

## Debugging Tips

### Check if peers connect
Look for log messages:
```
[B] Peer joined: <id> (1)
[A] Peer joined: <id> (1)
```

### Check if writer keys exchange
```
[B] Sent writer key to peer <id>
```

### Check autobase state
```javascript
console.log('activeWriters:', engine.autobase.base.activeWriters.map.size)
console.log('view length:', engine.autobase.base.view.length)
```

### Check entries
```javascript
const entries = await engine.autobase.list()
console.log('entries:', entries.length)
```

---

## Relevant Documentation

### Holepunch Docs
- Autobase: https://docs.pears.com/building-blocks/autobase
- Hyperswarm: https://docs.holepunch.to/building-blocks/hyperswarm
- Corestore: https://docs.holepunch.to/building-blocks/corestore

### Autobase Example (key reference)
```javascript
// From holepunchto/autobase examples/basic/index.mjs
async function apply(nodes, view, base) {
  for (const node of nodes) {
    if (node.value.add) {
      await base.addWriter(Buffer.from(node.value.add, 'hex'))
    }
    await view.append(node.value)
  }
}
```

### Key Insight
The `base` parameter in `apply` is a `PrivateApplyCalls` instance that has `addWriter()` method. This ONLY works inside the apply callback. Outside of apply, writer additions must go through appending messages.

---

## Commits This Session

1. `8a6ae4a` - feat: Add Autobase v2 sync engine with multi-writer support
2. `dd8ff31` - fix: Cross-peer file sync now working

---

## Next Session Checklist

- [ ] Run bidirectional sync test
- [ ] Manual CLI test between hals-shell and sprite
- [ ] Verify delete propagation
- [ ] Consider large file strategy
- [ ] Run full test suite: `npm test`
- [ ] Update README if needed

---

*Handoff created by Marshall, 2026-02-07*
